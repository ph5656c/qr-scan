<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>線材條碼掃描</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<h3>掃描 3D 列印線材條形碼</h3>

<button onclick="startScan()">開始掃描</button>
<input id="result" readonly style="width:100%; margin-top:10px;">

<video id="video" style="width:100%; max-width:320px;" playsinline></video>

<script type="module">
import { BrowserMultiFormatReader } from
  "https://unpkg.com/@zxing/browser@latest/esm/index.js";

const video = document.getElementById("video");
const resultInput = document.getElementById("result");
const codeReader = new BrowserMultiFormatReader();

window.startScan = async function () {
  try {
    const devices = await BrowserMultiFormatReader.listVideoInputDevices();
    const deviceId = devices[devices.length - 1].deviceId; // 後鏡頭

    codeReader.decodeFromVideoDevice(deviceId, video, (result, err) => {
      if (result) {
        resultInput.value = result.getText();
        codeReader.reset();
        sendToAPI(result.getText());
      }
    });
  } catch (e) {
    alert("無法啟動相機：" + e);
  }
}

function sendToAPI(code) {
  fetch("https://script.google.com/macros/s/XXXX/exec", {
    method: "POST",
    body: JSON.stringify({ barcode: code })
  });
}
</script>

</body>
</html>
